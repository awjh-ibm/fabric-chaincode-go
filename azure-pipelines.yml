# Copyright the Hyperledger Fabric contributors. All rights reserved.
#
# SPDX-License-Identifier: Apache-2.0

name: $(SourceBranchName)-$(Date:yyyyMMdd)$(Rev:.rrr)
trigger:
  batch: false
  branches:
    include:
      - master
      - release-*
      - FAB-*

variables:
  branch: $[ coalesce(variables['system.PullRequest.TargetBranch'], variables['build.SourceBranchName']) ]

pool:
  vmImage: ubuntu-16.04
container:
  image: golang:1.12.9-buster

steps:
  - checkout: self
    clean: true
    fetchDepth: 1

  - script: go get -u golang.org/x/lint/golint
    displayName: Install Go Linter

  - script: golint -set_exit_status ./...
    displayName: Lint Code

  - script: go vet ./...
    displayName: Vet Code

  - script: go test -race ./...
    displayName: Run Tests

  - script: go get -u github.com/DATA-DOG/godog/cmd/godog
    displayName: Install Godog

  - script: cd contractapi/internal/functionaltests; godog
    displayName: Run Functional Tests
